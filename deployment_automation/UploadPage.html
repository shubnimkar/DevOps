<!DOCTYPE html>
<html>
<head>
  <title>Upload Deployment Document</title>
  <script>
    function onLoad() {
      google.script.run.withSuccessHandler(populateDropdown).getPendingDeployments();
    }

    function populateDropdown(deployments) {
      var select = document.getElementById("deploymentSelect");
      select.innerHTML = "";

      if (deployments.length === 0) {
        select.innerHTML = "<option value=''>No pending deployments</option>";
        return;
      }

      deployments.forEach(function (deployment) {
        var option = document.createElement("option");
        option.value = deployment.row;
        option.textContent = `${deployment.project} - ${deployment.environment}`;
        select.appendChild(option);
      });
    }

    function uploadFile() {
      var fileInput = document.getElementById("fileInput");
      var deploymentSelect = document.getElementById("deploymentSelect");
      var progress = document.getElementById("progress");

      if (!fileInput.files.length || !deploymentSelect.value) {
        alert("Please select a deployment and upload a file.");
        return;
      }

      var file = fileInput.files[0];
      var reader = new FileReader();
      reader.onload = function (event) {
        var fileData = btoa(event.target.result);
        progress.textContent = "Uploading... Please wait";

        google.script.run.withSuccessHandler(function (response) {
          progress.textContent = response.message;
          if (response.status === "success") {
            alert("File uploaded successfully!");
            location.reload();
          }
        }).uploadDeploymentDocument(fileData, file.name, deploymentSelect.value);
      };

      reader.readAsBinaryString(file);
    }
  </script>
</head>
<body onload="onLoad()">
  <h2>Upload Deployment Document</h2>

  <label for="deploymentSelect">Select Deployment Request:</label>
  <select id="deploymentSelect"></select>

  <br><br>

  <label for="fileInput">Upload Deployment Document:</label>
  <input type="file" id="fileInput">

  <br><br>

  <button onclick="uploadFile()">Upload</button>
  <p id="progress"></p>
</body>
</html>
